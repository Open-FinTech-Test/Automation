name: Update branch protections for another
on:
  push:
    branches:
      - main

jobs:
  create_commit:
    runs-on: ubuntu-latest
    steps:
    - name: Update branch protections for another
      env:
        REVIEWER_COUNT: 2
      run: |
        curl -X PUT -H "Authorization: token ${{ secrets.ORG_ADMIN_TOKEN }}"\
        -H "Accept: application/vnd.github.v3+json"\
        https://api.github.com/repos/Open-FinTech-Test/kukure/contents/README.md \
        -d '{"message": "Create README.md", "content": "'"$(echo -n '# My project' | base64)"'", "branch": "main"}'
      
        curl --location --request PUT 'https://api.github.com/repos/Open-FinTech-Test/kukure/branches/main/protection' \
        --header 'Accept: application/vnd.github.luke-cage-preview+json' \
        --header 'Authorization: token ${{ secrets.ORG_ADMIN_TOKEN }}' \
        --header 'Content-Type: application/json' \
        --data-raw '{
        "required_status_checks": null, 
        "enforce_admins": false, 
        "required_pull_request_reviews": 
        {
          "dismiss_stale_reviews": false,
          "require_code_owner_reviews": false,
          "required_approving_review_count": ${{env.REVIEWER_COUNT}}
        }, 
        "restrictions": null
        }'
